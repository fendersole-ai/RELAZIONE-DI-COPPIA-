<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PRISM 2.0 - Test di Autovalutazione</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>

<div id="popup-consenso" class="popup-overlay">
    <div class="popup-content">
        <h2>Consenso Informato</h2>
        <p>
            Benvenuto in PRISM 2.0, un test gratuito e anonimo disponibile 24h su 24.
            PRISM è uno strumento di intelligenza artificiale progettato per rilevare possibili indicatori di rischio tramite 10 domande aperte.
            Non è una diagnosi, non sostituisce il personale specializzato ed è paragonabile a un termometro: indica soltanto il livello di rischio rilevato.
        </p>
        <p>
            Questo test è uno strumento sperimentale basato su intelligenza artificiale. Non è validato come diagnosi clinica o valutazione ufficiale. L’uso è anonimo, gratuito e i dati non vengono memorizzati. L’AI si limita ad analizzare le risposte per generare un indicatore di rischio. Accedendo, confermi di aver compreso queste condizioni.
        </p>
        <div class="popup-buttons">
            <button id="accetto">ACCETTO</button>
            <button id="annulla">ANNULLA</button>
        </div>
    </div>
</div>

<div id="chat-container">
    <header>Protocollo PRISM 2.0</header>
    <div id="chat-window" class="chat-window"></div>
    <div class="chat-input-container">
        <input type="text" id="messageInput" placeholder="Scrivi il tuo messaggio...">
        <button id="sendButton">Invia</button>
    </div>
</div>

<script>
    const popupConsenso = document.getElementById('popup-consenso');
    const chatContainer = document.getElementById('chat-container');
    const accettoBtn = document.getElementById('accetto');
    const annullaBtn = document.getElementById('annulla');
    const chatWindow = document.getElementById('chat-window');
    const messageInput = document.getElementById('messageInput');
    const sendButton = document.getElementById('sendButton');

    let sessionId = localStorage.getItem('sessionId') || crypto.randomUUID();
    localStorage.setItem('sessionId', sessionId);

    function addMessage(text, sender) {
        const messageElement = document.createElement('div');
        messageElement.classList.add('message', sender);
        messageElement.textContent = text;
        chatWindow.appendChild(messageElement);
        chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    async function sendMessage(input) {
        if (input.trim() === '') return;

        if (input !== '_START_PROTOCOL_') {
            addMessage(input, 'user');
        }

        messageInput.value = '';

        const loadingMessage = document.createElement('div');
        loadingMessage.classList.add('loading');
        loadingMessage.textContent = 'L’IA sta pensando...';
        chatWindow.appendChild(loadingMessage);
        chatWindow.scrollTop = chatWindow.scrollHeight;

        try {
            const response = await fetch('/prism', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ session_id: sessionId, input: input }),
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            chatWindow.removeChild(loadingMessage);
            addMessage(data.output, 'ai');

        } catch (error) {
            console.error('Errore:', error);
            chatWindow.removeChild(loadingMessage);
            addMessage('Si è verificato un errore. Riprova più tardi.', 'ai');
        }
    }

    accettoBtn.addEventListener('click', () => {
        popupConsenso.style.display = 'none';
        chatContainer.style.display = 'flex';
        sendMessage('_START_PROTOCOL_');
    });

    annullaBtn.addEventListener('click', () => {
        addMessage('Hai annullato. Ricarica la pagina per riprovare.', 'ai');
        setTimeout(() => {
            window.location.reload();
        }, 3000);
    });

    sendButton.addEventListener('click', () => {
        sendMessage(messageInput.value);
    });

    messageInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            sendMessage(messageInput.value);
        }
    });
</script>
</body>
</html>
